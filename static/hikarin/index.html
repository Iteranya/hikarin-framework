<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MobTalker - Visual Editor</title>
    
    <!-- TAILWIND & ICONS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <!-- BLOCKLY IMPORTS -->
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/en.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace']
                    },
                    colors: {
                        mob: { 500: '#22c55e', 600: '#16a34a', 900: '#14532d' },
                        dark: { 700: '#2d2d2d', 800: '#1e1e1e', 900: '#121212', 950: '#0a0a0a' }
                    }
                }
            }
        }
    </script>
<style>
    /* 1. SCROLLBARS */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e1e1e; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

    /* 2. BLOCKLY MAIN CANVAS */
    .blocklySvg { 
        background-color: #121212 !important; 
        outline: none;
    }

    /* 3. TOOLBOX BACKGROUND (The Fix) */
    /* Target every possible container name Blockly uses */
    .blocklyToolboxDiv, 
    .blocklyToolbox, 
    .blocklyToolboxContents,
    .blocklyToolboxDiv.blocklyToolboxDelete { 
        background-color: #1e1e1e !important; 
        color: #e5e7eb !important;
        border-right: 1px solid #2d2d2d;
    }

    /* 4. TEXT COLORS (Categories) */
    .blocklyTreeLabel { 
        color: #e5e7eb !important; /* Force Light Gray Text */
        font-family: 'Inter', sans-serif; 
        font-size: 13px;
        font-weight: 500;
    }

    /* 5. CATEGORY ROW HOVER/ACTIVE */
    /* When not selected */
    .blocklyTreeRow {
        border-left: 4px solid transparent; /* Placeholder for alignment */
    }
    
    /* Hover effect */
    .blocklyTreeRow:not(.blocklyTreeSelected):hover { 
        background-color: #2d2d2d !important; 
    }

    /* Selected Category */
    .blocklyTreeSelected .blocklyTreeRow { 
        background-color: #22c55e15 !important; /* Green tint */
        border-left: 4px solid #22c55e !important; /* Green line */
    }
    
    .blocklyTreeSelected .blocklyTreeLabel { 
        color: #22c55e !important; /* Green Text */
        font-weight: 700; 
    }

    /* 6. FLYOUT (The drawer that opens) */
    .blocklyFlyoutBackground { 
        fill: #1e1e1e !important; 
        fill-opacity: 0.95; 
    }

    /* 7. UI HELPERS */
    .nav-link.active { color: #fff; border-bottom: 2px solid #22c55e; background: rgba(255,255,255,0.05); }
    .editor-tab.active { background-color: #2d2d2d; color: #fff; border-bottom: 2px solid #22c55e; }
    .glass-panel { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(8px); border-left: 1px solid rgba(255, 255, 255, 0.1); }

    /* 8. HIDE GHOST SCROLLBARS */
    .blocklyFlyoutScrollbar {
        display: none !important;
        opacity: 0 !important;
    }
</style>
</head>
<body class="bg-dark-900 text-gray-200 font-sans h-screen flex flex-col overflow-hidden selection:bg-mob-500 selection:text-white">

    <!-- NAV -->
    <nav class="h-14 bg-dark-950 border-b border-gray-800 flex items-center justify-between px-4 z-40 flex-shrink-0">
        <div class="flex items-center gap-3 w-64">
            <div class="w-7 h-7 bg-mob-600 rounded flex items-center justify-center text-white font-bold text-sm shadow-lg shadow-mob-900/50">M</div>
            <span class="font-bold text-lg tracking-tight text-white">MobTalker SDK</span>
        </div>
        <div class="flex items-center h-full gap-8">
            <a href="/projects" class="nav-link active h-full flex items-center px-4 text-sm font-medium text-white transition"><i class="fa-solid fa-code-branch mr-2"></i> Projects</a>
            <a href="/library" class="nav-link h-full flex items-center px-4 text-sm font-medium text-gray-400 hover:text-white transition"><i class="fa-solid fa-book-open mr-2"></i> Library</a>
        </div>
        <!-- Autosave Indicator -->
        <div class="flex items-center gap-4 w-64 justify-end" id="save-status-container">
            <div class="px-3 py-1 bg-dark-800 rounded border border-gray-700 flex items-center gap-2">
                <div id="save-status-dot" class="w-2 h-2 rounded-full bg-gray-500"></div>
                <span id="save-status-text" class="text-xs text-gray-400">Ready</span>
            </div>
            <div class="w-8 h-8 rounded-full bg-gray-700 border border-gray-600"></div>
        </div>
    </nav>

    <!-- LAYOUT -->
    <div class="flex flex-1 overflow-hidden relative">

        <!-- FILE EXPLORER -->
        <aside class="w-64 bg-dark-800 border-r border-gray-800 flex flex-col z-30">
            <div class="p-4 border-b border-gray-800">
                <p class="text-[10px] uppercase font-bold text-gray-500 mb-1">Active Group</p>
                <div class="flex items-center justify-between">
                    <h2 class="text-sm font-bold text-white truncate">Script Files</h2>
                </div>
            </div>
            <!-- DYNAMIC FILE LIST -->
            <div class="flex-1 overflow-y-auto py-2">
                <div class="px-2" id="fileListContainer">
                    <!-- Javascript populates this -->
                    <div class="text-xs text-gray-500 text-center mt-4">Loading files...</div>
                </div>
            </div>
            <div class="p-3 border-t border-gray-800 bg-dark-900/50">
                <button class="w-full py-1.5 text-xs text-gray-400 hover:text-white border border-gray-700 rounded hover:bg-gray-700 transition">
                    <i class="fa-solid fa-plus mr-1"></i> New Script
                </button>
            </div>
        </aside>

        <!-- MAIN EDITOR -->
        <main class="flex-1 flex flex-col bg-dark-900 relative min-w-0">
            <!-- TOOLBAR -->
            <header class="h-10 bg-dark-800 border-b border-gray-800 flex items-center justify-between px-4 flex-shrink-0 select-none">
                <div class="flex h-full">
                    <button onclick="editor.setView('visual')" id="tab-visual" class="editor-tab active h-full px-4 text-xs font-medium flex items-center gap-2 border-r border-gray-800 transition">
                        <i class="fa-solid fa-puzzle-piece"></i> Visual
                    </button>
                    <button onclick="editor.setView('code')" id="tab-code" class="editor-tab h-full px-4 text-xs font-medium text-gray-400 hover:text-white hover:bg-dark-700 flex items-center gap-2 border-r border-gray-800 transition">
                        <i class="fa-solid fa-code"></i> Source
                    </button>
                </div>
                <!-- Current File Label -->
                <div id="lbl-current-file" class="text-xs text-gray-500 font-mono hidden md:block">
                   No File Selected
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="editor.toggleLivePreview()" id="btn-preview" class="text-xs bg-gray-700 hover:bg-mob-600 text-white px-3 py-1 rounded transition flex items-center gap-2">
                        <i class="fa-solid fa-columns"></i> <span class="hidden sm:inline">Split View</span>
                    </button>
                </div>
            </header>

            <!-- WORKSPACE AREA -->
            <div class="flex-1 relative flex overflow-hidden">
                
                <!-- 1. BLOCKLY CANVAS (Visual View) -->
                <div id="blocklyDiv" class="flex-1 bg-dark-900 z-10 relative" style="visibility: visible;"></div>

                <!-- 2. CODE EDITOR (Source View) - Now a sibling, not overlay -->
                <div id="codeEditorView" class="hidden flex-1 bg-dark-900 flex flex-col z-10 relative">
                    <div class="flex-1 p-4">
                        <div class="bg-dark-800 rounded-lg border border-gray-700 h-full flex flex-col shadow-inner">
                            <textarea id="fullSourceCode" class="flex-1 bg-dark-800 p-4 text-sm font-mono text-gray-300 resize-none outline-none" spellcheck="false"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 3. PREVIEW PANEL (Split View) -->
                <div id="codePreview" class="hidden w-96 glass-panel z-20 flex-col border-l border-gray-800">
                    <div class="h-8 bg-dark-950/50 flex items-center justify-between px-3 border-b border-white/5">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Generated Python</span>
                        <button onclick="editor.copyCode()" class="text-gray-500 hover:text-white text-xs"><i class="fa-regular fa-copy"></i></button>
                    </div>
                    <textarea id="generatedCode" readonly class="flex-1 bg-transparent p-4 text-xs font-mono text-blue-100 resize-none outline-none leading-relaxed selection:bg-mob-900"></textarea>
                </div>

            </div>
        </main>
    </div>

    <!-- TOOLBOX XML (Same as before) -->
    <xml id="toolbox" style="display: none">
        <category name="Setup" colour="#D35400">
            <block type="story_setup"></block>
            <block type="define_character"></block>
        </category>
        <category name="Flow Control" colour="#5C81A6">
            <block type="vn_label"></block>
            <block type="vn_jump"></block>
            <block type="vn_finish"></block>
        </category>
        <category name="Dialogue" colour="#5CA65C">
            <block type="vn_say"></block>
            <block type="vn_speak"></block>
            <block type="vn_sound_effect"></block>
        </category>
        <category name="Visuals" colour="#A65C81">
            <block type="vn_show"></block>
            <block type="vn_remove"></block>
            <block type="vn_remove_sprite"></block>
        </category>
        <category name="Logic" colour="#5C5CA6">
            <block type="vn_choice_menu">
                <statement name="OPTIONS">
                    <block type="vn_choice_option">
                        <field name="TEXT">Yes</field>
                        <field name="LABEL">lbl_yes</field>
                        <next>
                            <block type="vn_choice_option">
                                <field name="TEXT">No</field>
                                <field name="LABEL">lbl_no</field>
                            </block>
                        </next>
                    </block>
                </statement>
            </block>
            <block type="vn_choice_option"></block>
            <block type="vn_set_variable"></block>
            <block type="vn_modify_variable"></block>
            <block type="vn_conditional"></block>
            <block type="vn_conditional_time"></block>
        </category>
        <category name="Extras" colour="#808080">
            <block type="vn_idle_chats"></block>
            <block type="vn_unlock_dialogue"></block>
        </category>
    </xml>

    <!-- JS MODULE -->
     <div id="project-data" style="display: none;" data-slug="" data-group=""></div>
    <script type="module" src="/static/hikarin/js/main.js"></script>
</body>
</html>