// js/custom_blocks/story_setup.js

/**
 * @fileoverview The main "hat" block that wraps the entire story.
 * It generates the Python function definition, imports, and necessary setup calls.
 */

// BLOCK DEFINITION
// This is the visual part of the block.
export const definition = {
  "type": "story_setup",
  "message0": "Create Story ðŸ“–",
  "message1": "Setup (Define characters, variables, etc): %1 %2",
  "message2": "Story Flow (Dialogue, choices, etc): %1 %2",
  "args1": [
    { "type": "input_dummy" }, // For alignment and spacing
    { "type": "input_statement", "name": "SETUP_STACK" }
  ],
  "args2": [
    { "type": "input_dummy" },
    { "type": "input_statement", "name": "STORY_STACK" }
  ],
  "colour": 290,
  "tooltip": "The main block that wraps your entire visual novel script.",
  "helpUrl": ""
};

// BLOCK GENERATOR
// This is the logic that generates the Python code.
export const generator = (block) => {
  // Get the code generated by blocks connected to the "SETUP_STACK" input.
  // This will include all the 'define_character' blocks.
  const setupCode = Blockly.Python.statementToCode(block, 'SETUP_STACK');

  // Get the code generated by blocks connected to the "STORY_STACK" input.
  // This will be all the 'say', 'show', 'label', etc. blocks.
  const storyCode = Blockly.Python.statementToCode(block, 'STORY_STACK');

  // Define the Python script's header. This ensures the necessary
  // modules are always imported correctly.
  const header = `from src.modules import VisualNovelModule
from src.model import Character`;

  // Assemble the entire Python script.
  // The 'setupCode' and 'storyCode' variables will already have the correct indentation
  // because they come from statementToCode().
  const fullScript = `
${header}

def story():
  vn = VisualNovelModule()

${setupCode}

${storyCode}

  return vn.dialogueDict
`;

  // Return the complete, formatted script.
  // We trim it to remove any leading/trailing whitespace.
  return fullScript.trim();
};